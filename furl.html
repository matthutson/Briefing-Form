<!DOCTYPE html>
<html lang="en">
<!-- Previous head and style sections remain the same -->

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const form = document.getElementById('furlForm');
        const successMessage = document.getElementById('successMessage');
        const errorMessage = document.getElementById('errorMessage');

        // Previous formatDoc and htmlToJiraMarkup functions remain the same

        // New function to extract table data
        function extractTableData() {
            const rows = Array.from(document.querySelectorAll('#furlTable tbody tr'));
            return rows
                .map(row => {
                    const cells = Array.from(row.cells);
                    const friendlyUrl = cells[0].textContent.trim();
                    const destinationUrl = cells[1].textContent.trim();
                    
                    // Only return if both cells have content
                    if (friendlyUrl && destinationUrl) {
                        return {
                            friendlyUrl,
                            destinationUrl
                        };
                    }
                    return null;
                })
                .filter(row => row !== null); // Remove empty rows
        }

        // Form submission
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const debugPanel = document.getElementById('debugPanel');
            const debugOutput = document.getElementById('debugOutput');
            debugPanel.style.display = 'block';
            
            function log(message, data = null) {
                const timestamp = new Date().toISOString();
                let logMessage = `${timestamp}: ${message}\n`;
                if (data) {
                    logMessage += JSON.stringify(data, null, 2) + '\n';
                }
                debugOutput.textContent += logMessage;
                console.log(message, data);
            }

            const formContent = document.getElementById('furlTable').innerHTML;
            const jiraMarkup = htmlToJiraMarkup(formContent);
            const tableData = extractTableData();

            // Create Jira ticket data
            const jiraData = {
                title: document.getElementById('title').value,
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                description: jiraMarkup
            };

            // Create Google Sheets data
            const sheetsData = tableData.map(row => ({
                Summary: `FURL Request - ${row.friendlyUrl}`,
                'Due Date': new Date().toISOString().split('T')[0], // Today's date
                'Friendly URL': row.friendlyUrl,
                'Destination URL': row.destinationUrl
            }));

            try {
                // Send to Jira via n8n
                log('Sending request to Jira webhook...');
                const jiraResponse = await fetch('https://n8n-container-service.5ndtj2s2t8qdr.eu-west-2.cs.amazonlightsail.com/webhook/9c5d58f8-73a1-45c7-9360-6cedf7e94676', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(jiraData)
                });

                log(`Jira response status: ${jiraResponse.status}`);
                
                // Send to Google Sheets via n8n (you'll need to create a new webhook for this)
                log('Sending request to Google Sheets webhook...');
                const sheetsResponse = await fetch('YOUR_NEW_N8N_WEBHOOK_URL_FOR_SHEETS', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(sheetsData)
                });

                log(`Sheets response status: ${sheetsResponse.status}`);

                if (!jiraResponse.ok || !sheetsResponse.ok) {
                    throw new Error('Failed to submit one or more requests');
                }

                showMessage(successMessage);
                form.reset();
                document.querySelectorAll('#furlTable td[contenteditable="true"]')
                    .forEach(cell => cell.textContent = '');
                debugOutput.textContent = '';

            } catch (error) {
                log('Error occurred:', error.message);
                errorMessage.textContent = error.message;
                showMessage(errorMessage);
            }
        });
    });
</script>

<!-- Rest of the HTML remains the same -->
</html>
