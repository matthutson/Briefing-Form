<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Request Friendly URL</title>
    <!-- Previous styles remain the same -->
</head>
<body>
    <h1>Request Friendly URL</h1>
    
    <form id="furlForm">
        <input type="hidden" id="title" name="title" value="FRIENDLY URL">
        
        <div class="form-group">
            <label for="name">Your Name*</label>
            <input type="text" id="name" name="name" required>
        </div>
        
        <div class="form-group">
            <label for="email">Your Email*</label>
            <input type="email" id="email" name="email" required>
        </div>
        
        <div class="form-group">
            <label>Friendly URLs*</label>
            <div id="furlTable" class="editor-content">
                <table>
                    <thead>
                        <tr>
                            <th>Friendly URL</th>
                            <th>Destination URL with UTM tracking string</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr><td contenteditable="true"></td><td contenteditable="true"></td></tr>
                        <tr><td contenteditable="true"></td><td contenteditable="true"></td></tr>
                        <tr><td contenteditable="true"></td><td contenteditable="true"></td></tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <button type="submit" class="submit-btn">Submit</button>
    </form>

    <div id="successMessage" class="success-message">Friendly URLs submitted successfully!</div>
    <div id="errorMessage" class="error-message"></div>
    <div id="debugPanel" class="debug-panel">
        <h3>Debug Information</h3>
        <pre id="debugOutput"></pre>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('furlForm');
            const successMessage = document.getElementById('successMessage');
            const errorMessage = document.getElementById('errorMessage');
            const debugPanel = document.getElementById('debugPanel');
            const debugOutput = document.getElementById('debugOutput');
            
            // Show debug panel by default during testing
            debugPanel.style.display = 'block';

            function log(message, data = null) {
                const timestamp = new Date().toISOString();
                let logMessage = `${timestamp}: ${message}\n`;
                if (data) {
                    logMessage += JSON.stringify(data, null, 2) + '\n';
                }
                debugOutput.textContent += logMessage;
                console.log(message, data);
            }

            function showMessage(element, duration = 3000) {
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, duration);
            }

            function extractTableData() {
                const rows = Array.from(document.querySelectorAll('#furlTable tbody tr'));
                return rows
                    .map(row => {
                        const cells = Array.from(row.cells);
                        const friendlyUrl = cells[0].textContent.trim();
                        const destinationUrl = cells[1].textContent.trim();
                        
                        if (friendlyUrl && destinationUrl) {
                            return {
                                friendlyUrl,
                                destinationUrl
                            };
                        }
                        return null;
                    })
                    .filter(row => row !== null);
            }

            form.addEventListener('submit', async (e) => {
                e.preventDefault();
                debugOutput.textContent = ''; // Clear previous debug output
                
                try {
                    const tableData = extractTableData();
                    if (tableData.length === 0) {
                        throw new Error('Please fill in at least one row in the table');
                    }

                    const formData = {
                        title: document.getElementById('title').value,
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value,
                        furls: tableData
                    };

                    log('Sending data to webhook:', formData);

                    const response = await fetch('https://n8n-container-service.5ndtj2s2t8qdr.eu-west-2.cs.amazonlightsail.com/webhook/9c5d58f8-73a1-45c7-9360-6cedf7e94676', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    log(`Response status: ${response.status}`);
                    
                    const responseText = await response.text();
                    log('Response body:', responseText);

                    if (!response.ok) {
                        throw new Error(`Failed to submit: ${response.status} ${responseText}`);
                    }

                    showMessage(successMessage);
                    form.reset();
                    document.querySelectorAll('#furlTable td[contenteditable="true"]')
                        .forEach(cell => cell.textContent = '');

                } catch (error) {
                    log('Error occurred:', error.message);
                    errorMessage.textContent = error.message;
                    showMessage(errorMessage, 5000);
                }
            });
        });
    </script>
</body>
</html>
