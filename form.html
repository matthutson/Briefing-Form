<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comic Relief Content Brief</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
            color: #172B4D;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        input[type="text"],
        input[type="email"],
        input[type="date"],
        input[type="url"],
        select {
            width: 100%;
            padding: 0.5rem;
            border: 2px solid #DFE1E6;
            border-radius: 3px;
            font-size: 1rem;
            margin-bottom: 0.5rem;
        }
        .checkbox-group {
            border: 2px solid #DFE1E6;
            border-radius: 3px;
            padding: 1rem;
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
        }
        .checkbox-option {
            flex: 1 1 200px;
            min-width: 150px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .intro-text {
            margin-bottom: 2rem;
            line-height: 1.5;
        }
        .intro-text p {
            margin-bottom: 1rem;
        }
        .intro-text ol {
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }
        .intro-text ul {
            padding-left: 2rem;
            margin: 0.5rem 0;
        }
        .intro-text li {
            margin-bottom: 0.5rem;
        }
        .editor-toolbar {
            padding: 0.5rem;
            border: 2px solid #DFE1E6;
            border-bottom: none;
            border-radius: 3px 3px 0 0;
            background: #f4f5f7;
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .editor-toolbar button {
            padding: 0.25rem 0.5rem;
            background: white;
            border: 1px solid #DFE1E6;
            border-radius: 3px;
            cursor: pointer;
        }
        .editor-toolbar button:hover {
            background: #f4f5f7;
        }
        .editor-content {
            border: 2px solid #DFE1E6;
            border-top: none;
            border-radius: 0 0 3px 3px;
            padding: 0.5rem;
            min-height: 150px;
        }
        .submit-btn {
            background: #E31C3D;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 3px;
            font-size: 1rem;
            cursor: pointer;
        }
        .submit-btn:hover {
            background: #CD1736;
        }
        [contenteditable]:focus {
            outline: none;
        }
        .debug-panel {
            margin-top: 2rem;
            padding: 1rem;
            background: #f4f5f7;
            border-radius: 3px;
            display: none;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 1rem 0;
        }
        td, th {
            border: 1px solid #DFE1E6;
            padding: 0.5rem;
        }
    </style>
</head>
<body>
    <h1>Website Briefing Form</h1>
    
    <div class="intro-text">
        <p><strong>These briefing process are only for content pages that can be built by the CMS and don't require development. Development projects are handled by the product team - and you can find out how to brief in work to them here.</strong></p>
        
        <p>If you have a vague idea of what you want - but need help to firm up a plan. Please put a meeting in with Matt Hutson and we can discuss requirements.</p>
        
        <ol>
            <li>Prepare your requirements, copy and assets and fill out the briefing form</li>
            <li>The page will be designed in Figma and sent to you for feedback
                <ul>
                    <li>This is the stage where all of your stakeholders are consulted for feedback. You are responsible for collating feedback and making decisions on what should be on the page.</li>
                    <li>Suggested amends are better than questions</li>
                    <li>If a question is asked make sure you tag the relevant person so they know to answer it.</li>
                </ul>
            </li>
            <li>Feedback is collated into final design</li>
            <li>Sign off (Usually either you, the project lead or your line manager</li>
            <li>Page is published.</li>
        </ol>
        
        <p><strong>If you're updating an existing page, and don't need a design</strong> fill out this form:</p>
    </div>
    
    <form id="briefingForm">
        <div class="form-group">
            <label for="name">Your Name*</label>
            <input type="text" id="name" name="name" required>
        </div>
        
        <div class="form-group">
            <label for="email">Your Email*</label>
            <input type="email" id="email" name="email" required>
        </div>
        
        <div class="form-group">
            <label for="requestType">What do you need?*</label>
            <select id="requestType" name="requestType" required>
                <option value="">Select an option...</option>
                <option value="newPage">New Web Page</option>
                <option value="updatePage">Update Existing Webpage</option>
                <option value="blogNews">Blog or News Article</option>
            </select>
        </div>

        <div class="form-group">
            <label for="pageTitle">Page Title(s)*</label>
            <input type="text" id="pageTitle" name="pageTitle" required>
        </div>
        
        <div class="form-group">
            <label>What project or activity does this work fall under?*</label>
            <div class="checkbox-group">
                <div class="checkbox-option">
                    <input type="checkbox" id="rnd" name="projects" value="Red Nose Day">
                    <label for="rnd">Red Nose Day</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="sportRelief" name="projects" value="Sport Relief">
                    <label for="sportRelief">Sport Relief</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="winterAppeal" name="projects" value="Winter Appeal">
                    <label for="winterAppeal">Winter Appeal</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="365" name="projects" value="365">
                    <label for="365">365</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="funding" name="projects" value="Funding">
                    <label for="funding">Funding</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="moneyDoes" name="projects" value="What Your Money Does">
                    <label for="moneyDoes">What Your Money Does</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="partnerships" name="projects" value="Partnerships">
                    <label for="partnerships">Partnerships</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="operations" name="projects" value="Operations">
                    <label for="operations">Operations</label>
                </div>
                <div class="checkbox-option">
                    <input type="checkbox" id="legal" name="projects" value="Legal">
                    <label for="legal">Legal</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="dueDate">When do you need this live?*</label>
            <input type="date" id="dueDate" name="dueDate" required>
        </div>
        
        <div class="form-group">
            <label>A brief description of what you need and why*</label>
            <div class="editor-toolbar">
                <button type="button" onclick="formatDoc('formatBlock', 'description', 'P')">Normal text</button>
                <button type="button" onclick="formatDoc('formatBlock', 'description', 'H1')">H1</button>
                <button type="button" onclick="formatDoc('formatBlock', 'description', 'H2')">H2</button>
                <button type="button" onclick="formatDoc('formatBlock', 'description', 'H3')">H3</button>
                <button type="button" onclick="formatDoc('bold', 'description')">B</button>
                <button type="button" onclick="formatDoc('italic', 'description')">I</button>
                <button type="button" onclick="formatDoc('insertunorderedlist', 'description')">• List</button>
                <button type="button" onclick="formatDoc('insertorderedlist', 'description')">1. List</button>
                <button type="button" onclick="formatDoc('createlink', 'description')">Link</button>
                <button type="button" onclick="insertTable('description')">Table</button>
            </div>
            <div id="description" class="editor-content" contenteditable="true"></div>
        </div>
        
        <div class="form-group">
            <label>Please list each page name and URL of the pages you're briefing here:*</label>
            <div class="editor-toolbar">
                <button type="button" onclick="formatDoc('formatBlock', 'pages', 'P')">Normal text</button>
                <button type="button" onclick="formatDoc('formatBlock', 'pages', 'H1')">H1</button>
                <button type="button" onclick="formatDoc('formatBlock', 'pages', 'H2')">H2</button>
                <button type="button" onclick="formatDoc('formatBlock', 'pages', 'H3')">H3</button>
                <button type="button" onclick="formatDoc('bold', 'pages')">B</button>
                <button type="button" onclick="formatDoc('italic', 'pages')">I</button>
                <button type="button" onclick="formatDoc('insertunorderedlist', 'pages')">• List</button>
                <button type="button" onclick="formatDoc('insertorderedlist', 'pages')">1. List</button>
                <button type="button" onclick="formatDoc('createlink', 'pages')">Link</button>
                <button type="button" onclick="insertTable('pages')">Table</button>
            </div>
            <div id="pages" class="editor-content" contenteditable="true">https://www.comicrelief.com/add-path-here</div>
        </div>
        
        <div class="form-group">
            <label for="boxLink">Box link to folder containing text and images:</label>
            <input type="url" id="boxLink" name="boxLink" placeholder="https://comicrelief.app.box.com/...">
        </div>

        <div class="form-group">
            <label>Summary Copy</label>
            <p class="field-description" style="margin-bottom: 0.5rem; color: #6B778C; font-size: 0.9rem;">50 words of copy that can be used on landing pages that link to this page</p>
            <div class="editor-toolbar">
                <button type="button" onclick="formatDoc('formatBlock', 'summary', 'P')">Normal text</button>
                <button type="button" onclick="formatDoc('formatBlock', 'summary', 'H1')">H1</button>
                <button type="button" onclick="formatDoc('formatBlock', 'summary', 'H2')">H2</button>
                <button type="button" onclick="formatDoc('formatBlock', 'summary', 'H3')">H3</button>
                <button type="button" onclick="formatDoc('bold', 'summary')">B</button>
                <button type="button" onclick="formatDoc('italic', 'summary')">I</button>
                <button type="button" onclick="formatDoc('insertunorderedlist', 'summary')">• List</button>
                <button type="button" onclick="formatDoc('insertorderedlist', 'summary')">1. List</button>
                <button type="button" onclick="formatDoc('createlink', 'summary')">Link</button>
                <button type="button" onclick="insertTable('summary')">Table</button>
            </div>
            <div id="summary" class="editor-content" contenteditable="true"></div>
        </div>
        
        <button type="submit" class="submit-btn">Submit Brief</button>
    </form>

    <div id="debugPanel" class="debug-panel">
        <h3>Debug Information</h3>
        <pre id="debugOutput"></pre>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Create and style the modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                display: none;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 1000;
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 20px;
                border-radius: 5px;
                min-width: 300px;
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);

            function showModal(content) {
                modalContent.innerHTML = content;
                modal.style.display = 'block';
            }

            window.hideModal = function() {
                modal.style.display = 'none';
            }

            window.formatDoc = function(cmd, editorId, value = null) {
                if (cmd === 'formatBlock') {
                    document.execCommand(cmd, false, `<${value}>`);
                } else if (cmd === 'createlink') {
                    showModal(`
                        <h3 style="margin-bottom: 15px;">Insert Link</h3>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">Text to display:</label>
                            <input type="text" id="linkText" style="width: 100%; padding: 5px;">
                        </div>
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 5px;">URL:</label>
                            <input type="url" id="linkUrl" style="width: 100%; padding: 5px;">
                        </div>
                        <div style="text-align: right;">
                            <button onclick="insertLink('${editorId}')" style="background: #0052CC; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer;">Insert</button>
                            <button onclick="hideModal()" style="margin-left: 10px; padding: 8px 15px; border-radius: 3px; cursor: pointer;">Cancel</button>
                        </div>
                    `);
                    const selection = window.getSelection();
                    if (selection.toString()) {
                        document.getElementById('linkText').value = selection.toString();
                    }
                } else {
                    document.execCommand(cmd, false, value);
                }
                document.getElementById(editorId).focus();
            };

            window.insertLink = function(editorId) {
                const text = document.getElementById('linkText').value;
                const url = document.getElementById('linkUrl').value;
                
                if (url) {
                    const editor = document.getElementById(editorId);
                    editor.focus();
                    if (text) {
                        const link = `<a href="${url}" target="_blank">${text}</a>`;
                        document.execCommand('insertHTML', false, link);
                    } else {
                        document.execCommand('createlink', false, url);
                    }
                }
                hideModal();
            };

            window.insertTable = function(editorId) {
                showModal(`
                    <h3 style="margin-bottom: 15px;">Insert Table</h3>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Number of rows:</label>
                        <input type="number" id="tableRows" value="3" min="1" style="width: 100%; padding: 5px;">
                    </div>
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px;">Number of columns:</label>
                        <input type="number" id="tableCols" value="3" min="1" style="width: 100%; padding: 5px;">
                    </div>
                    <div style="text-align: right;">
                        <button onclick="createTable('${editorId}')" style="background: #0052CC; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer;">Insert</button>
                        <button onclick="hideModal()" style="margin-left: 10px; padding: 8px 15px; border-radius: 3px; cursor: pointer;">Cancel</button>
                    </div>
                `);
            };

            window.createTable = function(editorId) {
                const rows = parseInt(document.getElementById('tableRows').value) || 3;
                const cols = parseInt(document.getElementById('tableCols').value) || 3;
                
                let table = '<table style="border-collapse: collapse; width: 100%; margin: 1rem 0;"><tbody>';
                
                // Create header row
                table += '<tr>';
                for (let c = 0; c < cols; c++) {
                    table += '<th style="border: 1px solid #DFE1E6; padding: 8px; background: #f4f5f7;">Header ' + (c + 1) + '</th>';
                }
                table += '</tr>';
                
                // Create data rows
                for (let r = 1; r < rows; r++) {
                    table += '<tr>';
                    for (let c = 0; c < cols; c++) {
                        table += '<td style="border: 1px solid #DFE1E6; padding: 8px;">Cell ' + (r) + '-' + (c + 1) + '</td>';
                    }
                    table += '</tr>';
                }
                
                table += '</tbody></table>';
                
                const editor = document.getElementById(editorId);
                editor.focus();
                document.execCommand('insertHTML', false, table);
                hideModal();
            };

            function htmlToJiraMarkup(html) {
                // Create a temporary div to parse HTML
                const temp = document.createElement('div');
                temp.innerHTML = html;

                function processNode(node) {
                    let result = '';
                    
                    // Handle different node types
                    if (node.nodeType === Node.TEXT_NODE) {
                        return node.textContent;
                    }
                    
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        const tag = node.tagName.toLowerCase();
                        
                        // Process children first
                        let innerContent = Array.from(node.childNodes)
                            .map(child => processNode(child))
                            .join('');
                            
                        // Handle different HTML elements
                        switch(tag) {
                            case 'h1':
                                return `h1. ${innerContent}\n\n`;
                            case 'h2':
                                return `h2. ${innerContent}\n\n`;
                            case 'h3':
                                return `h3. ${innerContent}\n\n`;
                            case 'b':
                            case 'strong':
                                return `*${innerContent}*`;
                            case 'i':
                            case 'em':
                                return `_${innerContent}_`;
                            case 'a':
                                return `[${innerContent}|${node.getAttribute('href')}]`;
                            case 'ul':
                                return innerContent + '\n';
                            case 'ol':
                                return innerContent + '\n';
                            case 'li':
                                const parent = node.parentElement;
                                const prefix = parent.tagName.toLowerCase() === 'ul' ? '* ' : '# ';
                                return prefix + innerContent + '\n';
                            case 'table':
                                return innerContent + '\n';
                            case 'tr':
                                return '|' + innerContent + '\n';
                            case 'th':
                                return '||' + innerContent;
                            case 'td':
                                return '|' + innerContent;
                            case 'br':
                                return '\n';
                            case 'p':
                                return innerContent + '\n\n';
                            default:
                                return innerContent;
                        }
                    }
                    
                    return '';
                }

                return processNode(temp);
            }

            document.getElementById('briefingForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const debugPanel = document.getElementById('debugPanel');
                const debugOutput = document.getElementById('debugOutput');
                debugPanel.style.display = 'block';
                
                function log(message, data = null) {
                    const timestamp = new Date().toISOString();
                    let logMessage = `${timestamp}: ${message}\n`;
                    if (data) {
                        logMessage += JSON.stringify(data, null, 2) + '\n';
                    }
                    debugOutput.textContent += logMessage;
                    console.log(message, data);
                }

                // Get selected projects
                const selectedProjects = Array.from(document.querySelectorAll('input[name="projects"]:checked'))
                    .map(checkbox => checkbox.value);

                const formData = {
                    name: document.getElementById('name').value,
                    email: document.getElementById('email').value,
                    requestType: document.getElementById('requestType').value,
                    pageTitle: document.getElementById('pageTitle').value,
                    projects: selectedProjects,
                    dueDate: document.getElementById('dueDate').value,
                    description: htmlToJiraMarkup(document.getElementById('description').innerHTML),
                    pages: htmlToJiraMarkup(document.getElementById('pages').innerHTML),
                    summaryCopy: htmlToJiraMarkup(document.getElementById('summary').innerHTML),
                    boxLink: document.getElementById('boxLink').value
                };

                log('Form data to be sent:', formData);

                try {
                    log('Sending request to webhook...');
                    const response = await fetch('https://n8n-container-service.5ndtj2s2t8qdr.eu-west-2.cs.amazonlightsail.com/webhook-test/9c5d58f8-73a1-45c7-9360-6cedf7e94676', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                    log(`Response status: ${response.status}`);
                    const responseText = await response.text();
                    log('Response body:', responseText);

                    if (!response.ok) {
                        throw new Error(`Failed to create issue: ${response.status} ${responseText}`);
                    }

                    alert('Brief submitted successfully!');
                    document.getElementById('briefingForm').reset();
                    document.getElementById('description').innerHTML = '';
                    document.getElementById('pages').innerHTML = 'https://www.comicrelief.com/add-path-here';
                    debugOutput.textContent = '';

                } catch (error) {
                    log('Error occurred:', error.message);
                    alert('Error submitting brief: ' + error.message);
                }
            });
        });
    </script>
</body>
</html>
